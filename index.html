<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>å°åŒ—å¸‚åœè»Šå ´è³‡è¨Š</title>
  <!-- Leaflet åœ°åœ–æ¨£å¼ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
    #map { height: 500px; margin-bottom: 30px; border: 2px solid #ccc; border-radius: 8px; }
    .parking { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 15px 0; padding: 20px; transition: transform 0.2s; }
    .parking:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .parking-name { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
    .refresh-btn { background-color: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-bottom: 20px; }
    .refresh-btn:hover { background-color: #2980b9; }
    .label { font-weight: bold; color: #34495e; }
    .loading, .status { text-align: center; margin: 15px; }
    .error { background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; border-left: 4px solid #c62828; margin: 20px 0; }
    .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .surplus-green { color: green; font-weight: bold; }
    .surplus-red { color: red; font-weight: bold; }
    .nav-btn { margin-top: 10px; padding: 8px 20px; border-radius: 5px; border: none; background: #3b82f6; color: #fff; font-size: 15px; cursor: pointer; }
    .nav-btn:disabled { background: #aaa; }
    #user-location-status { font-size: 0.98em; margin-bottom: 10px; color: #555; text-align: center; }
  </style>
</head>
<body>

  <h2>ğŸš— å°åŒ—å¸‚åœè»Šå ´è³‡è¨Š</h2>
  <div id="map"></div>

  <div id="user-location-status"></div>

  <div style="text-align: center; margin: 20px 0;">
    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹åœè»Šå ´åç¨±"
      style="padding: 10px; width: 80%; max-width: 400px; font-size: 16px;" />
  </div>

  <div style="text-align: center;">
    <button class="refresh-btn" onclick="loadParking()" id="refreshBtn">
      ğŸ”„ é‡æ–°æ•´ç†
    </button>
  </div>

  <div id="status"></div>
  <div id="list"><div class="loading">ğŸ“¡ æ­£åœ¨è¼‰å…¥åœè»Šå ´è³‡è¨Š...</div></div>

  <!-- Leaflet åœ°åœ– JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let isLoading = false;
    let userLocation = null; // {lat, lng}

    // å–å¾—ä½¿ç”¨è€…ç›®å‰åº§æ¨™
    function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });
          },
          (err) => {
            reject('ç„¡æ³•å–å¾—æ‚¨çš„å®šä½è³‡è¨Šï¼ˆ' + err.message + 'ï¼‰');
          }
        );
      });
    }

    // é¡¯ç¤ºç›®å‰åº§æ¨™ï¼ˆçµ¦ä½¿ç”¨è€…åƒè€ƒï¼‰
    function updateUserLocationStatus(msg, isError = false) {
      const div = document.getElementById('user-location-status');
      div.textContent = msg;
      div.style.color = isError ? '#c62828' : '#065c10';
    }

    async function loadParking() {
      if (isLoading) return;

      isLoading = true;
      const refreshBtn = document.getElementById('refreshBtn');
      const statusDiv = document.getElementById('status');
      const listDiv = document.getElementById('list');

      refreshBtn.disabled = true;
      refreshBtn.textContent = 'â³ è¼‰å…¥ä¸­...';
      listDiv.innerHTML = '<div class="loading">ğŸ“¡ æ­£åœ¨è¼‰å…¥åœè»Šå ´è³‡è¨Š...</div>';
      statusDiv.innerHTML = '';

      // å…ˆå–å¾—å®šä½ï¼ˆæˆ–é‡è¨­ï¼‰
      try {
        updateUserLocationStatus('ğŸ” å–å¾—æ‚¨çš„ä½ç½®ä¸­...');
        userLocation = await getUserLocation();
        updateUserLocationStatus(`ğŸ“ æ‚¨çš„ä½ç½®ï¼š${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`);
      } catch (err) {
        userLocation = null;
        updateUserLocationStatus('âš ï¸ ' + err, true);
      }

      try {
        const res = await fetch('http://localhost:3000/api/parking');
        if (!res.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${res.status} ${res.statusText}`);
        const data = await res.json();
        listDiv.innerHTML = '';

        let parkingArray = Array.isArray(data) ? data : (Object.values(data).find(v => Array.isArray(v)) || []);
        if (parkingArray.length === 0) {
          listDiv.innerHTML = '<div class="status">ğŸ“­ ç›®å‰æ²’æœ‰åœè»Šå ´è³‡æ–™</div>';
          return;
        }

        statusDiv.innerHTML = `<div class="status success">âœ… æˆåŠŸè¼‰å…¥ ${parkingArray.length} å€‹åœè»Šå ´</div>`;

        // åœ°åœ–åˆå§‹åŒ–
        if (!window.mapInitialized) {
          window.map = L.map('map').setView([25.033964, 121.564472], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap è²¢ç»è€…'
          }).addTo(window.map);
          window.markersLayer = L.layerGroup().addTo(window.map);
          window.mapInitialized = true;
        } else {
          window.markersLayer.clearLayers();
        }

        parkingArray.forEach((parking, index) => {
          const div = document.createElement('div');
          div.className = 'parking';
          div.id = `parking-${index}`;

          const name = parking.CarParkName?.Zh_tw || parking.Name || `åœè»Šå ´ #${index + 1}`;
          const address = parking.Address || parking.Location || 'åœ°å€æœªæä¾›';
          const description = parking.Description || parking.Note || '';
          const lat = parking.CarParkPosition?.PositionLat || parking.Position?.Lat || parking.Latitude || '';
          const lon = parking.CarParkPosition?.PositionLon || parking.Position?.Lon || parking.Longitude || '';
          const totalSpace = parking.TotalSpace || parking.Capacity || '';
          const surplusSpace = parking.SurplusSpace || parking.Available || '';
          const availableSpaces = typeof parking.AvailableSpaces === 'number' ? parking.AvailableSpaces : null;

          div.innerHTML = `
            <div class="parking-name">${name}</div>
            <div class="parking-info">
                <div><span class="label">ğŸ  åœ°å€:</span> ${address}</div>
                ${description ? `<div><span class="label">ğŸ“ æè¿°:</span> ${description}</div>` : ''}
                ${lat && lon ? `<div><span class="label">ğŸ“ åº§æ¨™:</span> ${lat}, ${lon}</div>` : ''}
                ${totalSpace ? `<div><span class="label">ğŸ…¿ï¸ ç¸½è»Šä½:</span> ${totalSpace}</div>` : ''}
                ${availableSpaces !== null
                  ? `<div><span class="label">ğŸš˜ å‰©é¤˜è»Šä½:</span> 
                        <span class="${availableSpaces === 0 ? 'surplus-red' : 'surplus-green'}">
                            ${availableSpaces}
                        </span>
                    </div>`
                  : ''}
                <button class="nav-btn" ${!lat || !lon || !userLocation ? 'disabled title="è«‹å…ˆå…è¨±å®šä½æˆ–ç¼ºåº§æ¨™"' : ''}
                  onclick="navigateToParking(${lat}, ${lon}, this)">
                  ğŸ§­ å°èˆªåˆ°é€™è£¡
                </button>
            </div>
          `;

          listDiv.appendChild(div);

          if (lat && lon) {
            const marker = L.marker([parseFloat(lat), parseFloat(lon)]);
            marker.bindPopup(`<strong>${name}</strong><br/>${address}`);
            marker.on('click', () => {
              const target = document.getElementById(`parking-${index}`);
              if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.style.backgroundColor = '#fff8e1';
                setTimeout(() => {
                  target.style.backgroundColor = 'white';
                }, 1500);
              }
            });
            window.markersLayer.addLayer(marker);
          }
        });

      } catch (err) {
        console.error('âŒ è¼‰å…¥éŒ¯èª¤:', err);
        listDiv.innerHTML = `
          <div class="error">
            <strong>ğŸš« è¼‰å…¥å¤±æ•—</strong><br/>
            éŒ¯èª¤è¨Šæ¯: ${err.message}<br/>
            <small>è«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ</small>
          </div>
        `;
      } finally {
        isLoading = false;
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'ğŸ”„ é‡æ–°æ•´ç†';
      }
    }

    // ç”¢ç”Ÿå°èˆªé€£çµä¸¦æ‰“é–‹
    async function navigateToParking(destLat, destLng, btn) {
      if (!userLocation) {
        alert('è«‹å…ˆå…è¨±å®šä½æ¬Šé™ï¼Œæ‰èƒ½ä½¿ç”¨å°èˆªåŠŸèƒ½ï¼');
        return;
      }
      btn.disabled = true;
      btn.textContent = 'â³ ç”¢ç”Ÿå°èˆªä¸­...';

      try {
        const navRes = await fetch(
          `http://localhost:3000/api/navigation?originLat=${userLocation.lat}&originLng=${userLocation.lng}&destLat=${destLat}&destLng=${destLng}`
        );
        const navData = await navRes.json();
        if (navData.success && navData.navigationUrl) {
          window.open(navData.navigationUrl, '_blank');
        } else {
          alert('å°èˆªç¶²å€ç”¢ç”Ÿå¤±æ•—');
        }
      } catch (e) {
        alert('ç”¢ç”Ÿå°èˆªå¤±æ•—ï¼š' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ§­ å°èˆªåˆ°é€™è£¡';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadParking();

      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.toLowerCase();
          const cards = document.querySelectorAll('.parking');
          cards.forEach(card => {
            const name = card.querySelector('.parking-name')?.textContent.toLowerCase() || '';
            card.style.display = name.includes(query) ? '' : 'none';
          });
        });
      }
    });
  </script>
</body>
</html>
